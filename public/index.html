<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mitmproxy UI - iOS Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tutorial-subtab-content { display: block; }
    .tutorial-subtab-content.hidden { display: none; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; }
    .status-running { background-color: #22c55e; animation: pulse 2s infinite; }
    .status-stopped { background-color: #ef4444; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .traffic-item:hover { background-color: #f3f4f6; }
    .method-get { color: #22c55e; }
    .method-post { color: #3b82f6; }
    .method-put { color: #f59e0b; }
    .method-delete { color: #ef4444; }
    .status-2xx { color: #22c55e; }
    .status-3xx { color: #3b82f6; }
    .status-4xx { color: #f59e0b; }
    .status-5xx { color: #ef4444; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .setup-step { transition: all 0.3s; }
    .setup-step.completed { opacity: 0.6; }
    .setup-step.completed .step-number { background-color: #22c55e; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h1 class="text-xl font-bold text-gray-800">mitmproxy UI</h1>
          <span class="text-sm text-gray-500">iOS Simulator API Mocking</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <div id="proxyStatus" class="status-dot status-stopped"></div>
            <span id="proxyStatusText" class="text-sm text-gray-600">Proxy Stopped</span>
          </div>
          <button id="toggleProxy" onclick="toggleProxy()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
            Start Proxy
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="max-w-7xl mx-auto px-4 mt-4">
    <div class="flex gap-1 border-b">
      <button onclick="switchTab('setup')" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600" data-tab="setup">
        Setup Guide
      </button>
      <button onclick="switchTab('traffic')" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="traffic">
        Live Traffic
      </button>
      <button onclick="switchTab('rules')" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="rules">
        Mock Rules
      </button>
      <button onclick="switchTab('simulators')" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="simulators">
        Simulators
      </button>
      <button onclick="switchTab('recordings')" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="recordings">
        Recordings
      </button>
      <button onclick="switchTab('tutorial')" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="tutorial">
        Tutorial
      </button>
    </div>
  </div>

  <!-- Tab Contents -->
  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- Setup Guide Tab -->
    <div id="tab-setup" class="tab-content active">
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">iOS Simulator Setup Guide</h2>
        <p class="text-gray-600 mb-6">Follow these steps to configure mitmproxy with your iOS Simulator:</p>

        <div class="space-y-4">
          <!-- Step 1 -->
          <div class="setup-step p-4 bg-gray-50 rounded-lg border" id="step-1">
            <div class="flex items-start gap-4">
              <div class="step-number w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">1</div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800">Start the Proxy</h3>
                <p class="text-gray-600 text-sm mt-1">Click the "Start Proxy" button in the header to launch mitmproxy on port 8080.</p>
                <div class="mt-3">
                  <button onclick="toggleProxy(); markStepComplete(1);" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                    Start Proxy
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="setup-step p-4 bg-gray-50 rounded-lg border" id="step-2">
            <div class="flex items-start gap-4">
              <div class="step-number w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">2</div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800">Enable Mac Proxy Settings</h3>
                <p class="text-gray-600 text-sm mt-1">iOS Simulator uses your Mac's network. Enable the proxy on your Mac:</p>
                <div class="mt-3 flex gap-2">
                  <button onclick="enableMacProxy(); markStepComplete(2);" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                    Enable Mac Proxy
                  </button>
                  <button onclick="disableMacProxy();" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">
                    Disable Mac Proxy
                  </button>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                  <span id="macProxyStatus">Status: Unknown</span>
                </div>
                <details class="mt-2">
                  <summary class="text-sm text-blue-600 cursor-pointer">Manual commands</summary>
                  <pre class="mt-2 p-2 bg-gray-800 text-green-400 text-xs rounded overflow-x-auto">
# Enable proxy
networksetup -setwebproxy "Wi-Fi" 127.0.0.1 8080
networksetup -setsecurewebproxy "Wi-Fi" 127.0.0.1 8080

# Disable proxy
networksetup -setwebproxystate "Wi-Fi" off
networksetup -setsecurewebproxystate "Wi-Fi" off</pre>
                </details>
              </div>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="setup-step p-4 bg-gray-50 rounded-lg border" id="step-3">
            <div class="flex items-start gap-4">
              <div class="step-number w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">3</div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800">Boot iOS Simulator</h3>
                <p class="text-gray-600 text-sm mt-1">Select and boot a simulator from the Simulators tab, or use this quick launcher:</p>
                <div class="mt-3">
                  <select id="quickSimulatorSelect" class="px-3 py-1.5 border rounded text-sm mr-2">
                    <option value="">Loading simulators...</option>
                  </select>
                  <button onclick="bootSelectedSimulator(); markStepComplete(3);" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                    Boot Simulator
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4 -->
          <div class="setup-step p-4 bg-gray-50 rounded-lg border" id="step-4">
            <div class="flex items-start gap-4">
              <div class="step-number w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">4</div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800">Install mitmproxy Certificate</h3>
                <p class="text-gray-600 text-sm mt-1">For HTTPS traffic interception, install the mitmproxy certificate:</p>
                <ol class="mt-3 space-y-2 text-sm text-gray-700">
                  <li class="flex items-start gap-2">
                    <span class="font-mono bg-gray-200 px-1.5 py-0.5 rounded text-xs">4.1</span>
                    <span>Open <strong>Safari</strong> in the iOS Simulator</span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="font-mono bg-gray-200 px-1.5 py-0.5 rounded text-xs">4.2</span>
                    <span>Navigate to <code class="bg-yellow-100 px-1 rounded">http://mitm.it</code></span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="font-mono bg-gray-200 px-1.5 py-0.5 rounded text-xs">4.3</span>
                    <span>Tap <strong>"Apple"</strong> to download the certificate</span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="font-mono bg-gray-200 px-1.5 py-0.5 rounded text-xs">4.4</span>
                    <span>Go to <strong>Settings ‚Üí General ‚Üí VPN & Device Management</strong></span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="font-mono bg-gray-200 px-1.5 py-0.5 rounded text-xs">4.5</span>
                    <span>Tap <strong>mitmproxy</strong> profile ‚Üí <strong>Install</strong></span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="font-mono bg-gray-200 px-1.5 py-0.5 rounded text-xs">4.6</span>
                    <span>Go to <strong>Settings ‚Üí General ‚Üí About ‚Üí Certificate Trust Settings</strong></span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="font-mono bg-gray-200 px-1.5 py-0.5 rounded text-xs">4.7</span>
                    <span>Enable <strong>full trust</strong> for mitmproxy certificate</span>
                  </li>
                </ol>
                <div class="mt-3">
                  <button onclick="markStepComplete(4);" class="px-3 py-1.5 bg-green-500 text-white text-sm rounded hover:bg-green-600">
                    Mark as Complete
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 5 -->
          <div class="setup-step p-4 bg-gray-50 rounded-lg border" id="step-5">
            <div class="flex items-start gap-4">
              <div class="step-number w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">5</div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800">Test the Connection</h3>
                <p class="text-gray-600 text-sm mt-1">Open any app or Safari in the Simulator and make a network request. You should see traffic appear in the "Live Traffic" tab!</p>
                <div class="mt-3">
                  <button onclick="switchTab('traffic'); markStepComplete(5);" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                    View Live Traffic
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Troubleshooting -->
        <div class="mt-8 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
          <h3 class="font-semibold text-yellow-800 mb-2">Troubleshooting</h3>
          <ul class="text-sm text-yellow-700 space-y-1">
            <li>‚Ä¢ <strong>No traffic showing?</strong> Make sure Mac proxy is enabled and mitmproxy is running.</li>
            <li>‚Ä¢ <strong>HTTPS not working?</strong> Ensure the certificate is installed AND trusted (step 4.7).</li>
            <li>‚Ä¢ <strong>App uses certificate pinning?</strong> You'll need to disable pinning in the app code.</li>
            <li>‚Ä¢ <strong>Certificate expired?</strong> Delete old cert in Settings, restart mitmproxy, reinstall.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Live Traffic Tab -->
    <div id="tab-traffic" class="tab-content">
      <div class="bg-white rounded-lg shadow">
        <!-- Header Row -->
        <div class="p-4 border-b">
          <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-4">
              <h2 class="font-semibold text-lg whitespace-nowrap">Live Traffic</h2>
              <span id="trafficCount" class="px-2 py-0.5 bg-gray-100 text-gray-600 text-sm rounded-full whitespace-nowrap">0 requests</span>
            </div>
            <!-- Search field -->
            <div class="flex-1 max-w-md">
              <div class="relative">
                <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input type="text" id="searchInput" placeholder="Search URL, path, query..." class="w-full pl-9 pr-8 py-1.5 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" oninput="onSearchInput()">
                <button id="clearSearchBtn" onclick="clearSearch()" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="trafficPauseBtn" onclick="toggleTrafficPause()" class="flex items-center gap-1.5 px-3 py-1.5 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition">
                <span id="trafficPauseIcon">‚è∏</span>
                <span id="trafficPauseText">Pause</span>
              </button>
              <div class="relative">
                <button onclick="toggleBaseUrlDropdown()" id="filterDropdownBtn" class="flex items-center gap-2 px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-gray-50 transition">
                  <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                  </svg>
                  <span>Filter</span>
                  <span id="filterCount" class="hidden px-1.5 py-0.5 bg-blue-500 text-white text-xs rounded-full">0</span>
                  <span class="text-gray-400">‚ñº</span>
                </button>
                <div id="baseUrlDropdown" class="hidden absolute top-full right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 w-80">
                  <div class="p-3 border-b bg-gray-50 rounded-t-lg">
                    <div class="flex justify-between items-center">
                      <span class="font-medium text-sm text-gray-700">Filter by Host</span>
                      <button onclick="clearAllFilters()" class="text-red-500 hover:text-red-700 text-xs font-medium">Clear all</button>
                    </div>
                  </div>
                  <!-- Custom filter input -->
                  <div class="p-2 border-b">
                    <div class="flex gap-2">
                      <input type="text" id="customFilterInput" placeholder="e.g., tuntun.co.id" class="flex-1 px-2 py-1.5 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-blue-500" onkeydown="if(event.key==='Enter')addCustomFilter()">
                      <button onclick="addCustomFilter()" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">Add</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Add custom pattern (matches subdomains)</p>
                  </div>
                  <div id="baseUrlList" class="max-h-48 overflow-y-auto"></div>
                  <div class="p-2 border-t bg-gray-50 rounded-b-lg">
                    <p class="text-xs text-gray-400 text-center">Hosts are auto-detected from traffic</p>
                  </div>
                </div>
              </div>
              <button onclick="clearTraffic()" class="flex items-center gap-1.5 px-3 py-1.5 bg-red-50 text-red-600 text-sm rounded-lg hover:bg-red-100 transition border border-red-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Clear
              </button>
            </div>
          </div>
        </div>
        <!-- Filter Tags Row (shown when filters active) -->
        <div id="filterTagsRow" class="hidden px-4 py-2 bg-blue-50 border-b">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-xs text-blue-600 font-medium">Active filters:</span>
            <div id="filterTags" class="flex gap-1 flex-wrap"></div>
          </div>
        </div>
        <!-- Hidden input to maintain compatibility -->
        <input type="hidden" id="trafficFilter" value="">
        <div id="trafficList" class="divide-y max-h-[600px] overflow-y-auto">
          <div class="p-8 text-center text-gray-400">
            No traffic captured yet. Make requests from iOS Simulator to see them here.
          </div>
        </div>
      </div>
    </div>

    <!-- Mock Rules Tab -->
    <div id="tab-rules" class="tab-content">
      <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex items-center justify-between">
          <h2 class="font-semibold">Mock Rules</h2>
          <div class="flex gap-2">
            <button onclick="exportRules()" class="px-3 py-1.5 bg-gray-100 text-gray-700 text-sm rounded hover:bg-gray-200">Export</button>
            <button onclick="showRuleModal()" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">+ Add Rule</button>
          </div>
        </div>
        <div id="rulesList" class="divide-y">
          <div class="p-8 text-center text-gray-400">
            No mock rules configured. Create a rule to start mocking API responses.
          </div>
        </div>
      </div>
    </div>

    <!-- Simulators Tab -->
    <div id="tab-simulators" class="tab-content">
      <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex items-center justify-between">
          <h2 class="font-semibold">iOS Simulators</h2>
          <button onclick="loadSimulators()" class="px-3 py-1.5 bg-gray-100 text-gray-700 text-sm rounded hover:bg-gray-200">Refresh</button>
        </div>
        <div id="simulatorsList" class="divide-y">
          <div class="p-8 text-center text-gray-400">Loading simulators...</div>
        </div>
      </div>
    </div>

    <!-- Recordings Tab -->
    <div id="tab-recordings" class="tab-content">
      <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex items-center justify-between">
          <div class="flex items-center gap-4">
            <h2 class="font-semibold">Recordings</h2>
            <span id="recordingStatus" class="text-sm text-gray-500"></span>
          </div>
          <div class="flex gap-2">
            <button id="recordBtn" onclick="toggleRecording()" class="px-3 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600">
              Start Recording
            </button>
          </div>
        </div>
        <div id="recordingsList" class="divide-y">
          <div class="p-8 text-center text-gray-400">No recordings yet. Start recording to capture traffic sessions.</div>
        </div>
      </div>
    </div>

    <!-- Tutorial Tab -->
    <div id="tab-tutorial" class="tab-content">
      <!-- Tutorial Sub-tabs -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="flex border-b overflow-x-auto">
          <button onclick="switchTutorialSubTab('mock-rules')" class="tutorial-sub-tab px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap" data-subtab="mock-rules">
            Mock Rules
          </button>
          <button onclick="switchTutorialSubTab('real-iphone')" class="tutorial-sub-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-subtab="real-iphone">
            Real iPhone
          </button>
          <button onclick="switchTutorialSubTab('mac-browser')" class="tutorial-sub-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-subtab="mac-browser">
            Mac Browser
          </button>
          <button onclick="switchTutorialSubTab('ios-simulator')" class="tutorial-sub-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-subtab="ios-simulator">
            iOS Simulator
          </button>
          <button onclick="switchTutorialSubTab('faq')" class="tutorial-sub-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-subtab="faq">
            FAQ
          </button>
        </div>
      </div>

      <!-- Sub-tab: Mock Rules -->
      <div id="subtab-mock-rules" class="tutorial-subtab-content">
        <div class="space-y-6">
          <!-- Introduction -->
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Mock Rules Tutorial</h2>
            <p class="text-gray-600">Learn how to intercept API requests and return custom responses for testing your iOS app.</p>
          </div>

        <!-- What is Mocking -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">What is API Mocking?</h3>
          <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
            <p class="text-blue-800">API Mocking allows you to intercept network requests and return <strong>fake responses</strong> instead of calling the real server.</p>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-4 bg-gray-50 rounded-lg">
              <h4 class="font-semibold text-green-700 mb-2">Use Cases</h4>
              <ul class="text-sm text-gray-600 space-y-1">
                <li>‚Ä¢ Test error scenarios (500, 404, 401)</li>
                <li>‚Ä¢ Test with specific data</li>
                <li>‚Ä¢ Work offline without real API</li>
                <li>‚Ä¢ Simulate slow network</li>
                <li>‚Ä¢ Test edge cases</li>
              </ul>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
              <h4 class="font-semibold text-blue-700 mb-2">How it Works</h4>
              <div class="text-sm text-gray-600 font-mono bg-white p-3 rounded border">
                App Request<br>
                &nbsp;&nbsp;&nbsp;‚Üì<br>
                mitmproxy<br>
                &nbsp;&nbsp;&nbsp;‚Üì<br>
                Check Mock Rules<br>
                &nbsp;&nbsp;&nbsp;‚Üì<br>
                Match? ‚Üí Return Fake Response<br>
                No Match? ‚Üí Forward to Server
              </div>
            </div>
          </div>
        </div>

        <!-- Method 1: From Traffic -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center gap-3 mb-4">
            <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">1</span>
            <h3 class="text-lg font-semibold text-gray-800">Method 1: Create Mock from Live Traffic (Easiest)</h3>
          </div>

          <div class="space-y-4">
            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
              <span class="w-6 h-6 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">1</span>
              <div>
                <h4 class="font-semibold">Capture Traffic</h4>
                <p class="text-sm text-gray-600">Use your app normally. All API requests will appear in the <strong>Live Traffic</strong> tab.</p>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
              <span class="w-6 h-6 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">2</span>
              <div>
                <h4 class="font-semibold">Click on a Request</h4>
                <p class="text-sm text-gray-600">Find the API request you want to mock and click on it to see details.</p>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
              <span class="w-6 h-6 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">3</span>
              <div>
                <h4 class="font-semibold">Click "Create Mock Rule"</h4>
                <p class="text-sm text-gray-600">This will pre-fill the mock rule form with the actual response data.</p>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
              <span class="w-6 h-6 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">4</span>
              <div>
                <h4 class="font-semibold">Modify the Response</h4>
                <p class="text-sm text-gray-600">Change the response body, status code, or add a delay as needed.</p>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
              <span class="w-6 h-6 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">5</span>
              <div>
                <h4 class="font-semibold">Save and Test</h4>
                <p class="text-sm text-gray-600">Save the rule and refresh your app. The mocked response will be returned!</p>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <button onclick="switchTab('traffic')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
              Go to Live Traffic ‚Üí
            </button>
          </div>
        </div>

        <!-- Method 2: Manual -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center gap-3 mb-4">
            <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">2</span>
            <h3 class="text-lg font-semibold text-gray-800">Method 2: Create Mock Rule Manually</h3>
          </div>

          <div class="space-y-4">
            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
              <span class="w-6 h-6 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">1</span>
              <div>
                <h4 class="font-semibold">Go to Mock Rules Tab</h4>
                <p class="text-sm text-gray-600">Click on the <strong>Mock Rules</strong> tab in the navigation.</p>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
              <span class="w-6 h-6 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">2</span>
              <div>
                <h4 class="font-semibold">Click "+ Add Rule"</h4>
                <p class="text-sm text-gray-600">This opens the rule creation form.</p>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
              <span class="w-6 h-6 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">3</span>
              <div>
                <h4 class="font-semibold">Fill in the Rule Details</h4>
                <p class="text-sm text-gray-600 mb-2">Configure the URL pattern, method, and response.</p>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <button onclick="switchTab('rules')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
              Go to Mock Rules ‚Üí
            </button>
          </div>
        </div>

        <!-- Rule Fields Explained -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Rule Fields Explained</h3>

          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="bg-gray-100">
                  <th class="text-left p-3 font-semibold">Field</th>
                  <th class="text-left p-3 font-semibold">Description</th>
                  <th class="text-left p-3 font-semibold">Example</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <tr>
                  <td class="p-3 font-medium">Description</td>
                  <td class="p-3 text-gray-600">A name to identify this rule</td>
                  <td class="p-3 font-mono text-xs bg-gray-50">Mock login error</td>
                </tr>
                <tr>
                  <td class="p-3 font-medium">URL Pattern</td>
                  <td class="p-3 text-gray-600">Which URLs to match</td>
                  <td class="p-3 font-mono text-xs bg-gray-50">*/api/v1/login*</td>
                </tr>
                <tr>
                  <td class="p-3 font-medium">Pattern Type</td>
                  <td class="p-3 text-gray-600">How to match the URL</td>
                  <td class="p-3 font-mono text-xs bg-gray-50">wildcard, exact, regex</td>
                </tr>
                <tr>
                  <td class="p-3 font-medium">Method</td>
                  <td class="p-3 text-gray-600">HTTP method to match</td>
                  <td class="p-3 font-mono text-xs bg-gray-50">GET, POST, ANY</td>
                </tr>
                <tr>
                  <td class="p-3 font-medium">Status Code</td>
                  <td class="p-3 text-gray-600">Response HTTP status</td>
                  <td class="p-3 font-mono text-xs bg-gray-50">200, 401, 500</td>
                </tr>
                <tr>
                  <td class="p-3 font-medium">Response Body</td>
                  <td class="p-3 text-gray-600">The fake JSON to return</td>
                  <td class="p-3 font-mono text-xs bg-gray-50">{"error": "Unauthorized"}</td>
                </tr>
                <tr>
                  <td class="p-3 font-medium">Delay (ms)</td>
                  <td class="p-3 text-gray-600">Simulate slow network</td>
                  <td class="p-3 font-mono text-xs bg-gray-50">2000 = 2 seconds</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pattern Types -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">URL Pattern Types</h3>

          <div class="space-y-4">
            <div class="p-4 border rounded-lg">
              <h4 class="font-semibold text-purple-700">Wildcard (Recommended)</h4>
              <p class="text-sm text-gray-600 mb-2">Use <code class="bg-gray-100 px-1 rounded">*</code> to match any characters</p>
              <div class="font-mono text-sm bg-gray-800 text-green-400 p-3 rounded">
                */api/users/*<br>
                <span class="text-gray-500"># Matches: https://api.example.com/api/users/123</span><br>
                <span class="text-gray-500"># Matches: https://api.example.com/api/users/profile</span>
              </div>
            </div>

            <div class="p-4 border rounded-lg">
              <h4 class="font-semibold text-blue-700">Exact Match</h4>
              <p class="text-sm text-gray-600 mb-2">Must match the complete URL exactly</p>
              <div class="font-mono text-sm bg-gray-800 text-green-400 p-3 rounded">
                https://api.example.com/api/v1/login<br>
                <span class="text-gray-500"># Only matches this exact URL</span>
              </div>
            </div>

            <div class="p-4 border rounded-lg">
              <h4 class="font-semibold text-orange-700">Regex (Advanced)</h4>
              <p class="text-sm text-gray-600 mb-2">Use regular expressions for complex matching</p>
              <div class="font-mono text-sm bg-gray-800 text-green-400 p-3 rounded">
                .*\/users\/\d+<br>
                <span class="text-gray-500"># Matches: /users/123, /users/456</span><br>
                <span class="text-gray-500"># Does NOT match: /users/profile</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Examples -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Example Mock Rules</h3>

          <div class="space-y-4">
            <!-- Example 1: Error Response -->
            <div class="p-4 border-l-4 border-red-500 bg-red-50 rounded-r-lg">
              <h4 class="font-semibold text-red-700 mb-2">Example 1: Mock Login Error (401)</h4>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <p class="text-xs text-gray-500 mb-1">Configuration:</p>
                  <div class="font-mono text-xs bg-white p-2 rounded border">
                    URL Pattern: */api/*/login*<br>
                    Method: POST<br>
                    Status Code: 401<br>
                    Delay: 500
                  </div>
                </div>
                <div>
                  <p class="text-xs text-gray-500 mb-1">Response Body:</p>
                  <pre class="font-mono text-xs bg-white p-2 rounded border overflow-x-auto">{
  "error": "Invalid credentials",
  "code": "AUTH_FAILED"
}</pre>
                </div>
              </div>
            </div>

            <!-- Example 2: Success Response -->
            <div class="p-4 border-l-4 border-green-500 bg-green-50 rounded-r-lg">
              <h4 class="font-semibold text-green-700 mb-2">Example 2: Mock User Profile (200)</h4>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <p class="text-xs text-gray-500 mb-1">Configuration:</p>
                  <div class="font-mono text-xs bg-white p-2 rounded border">
                    URL Pattern: */api/users/profile*<br>
                    Method: GET<br>
                    Status Code: 200<br>
                    Delay: 0
                  </div>
                </div>
                <div>
                  <p class="text-xs text-gray-500 mb-1">Response Body:</p>
                  <pre class="font-mono text-xs bg-white p-2 rounded border overflow-x-auto">{
  "id": 123,
  "name": "Test User",
  "email": "test@example.com",
  "balance": 1000000
}</pre>
                </div>
              </div>
            </div>

            <!-- Example 3: Server Error -->
            <div class="p-4 border-l-4 border-orange-500 bg-orange-50 rounded-r-lg">
              <h4 class="font-semibold text-orange-700 mb-2">Example 3: Mock Server Error (500)</h4>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <p class="text-xs text-gray-500 mb-1">Configuration:</p>
                  <div class="font-mono text-xs bg-white p-2 rounded border">
                    URL Pattern: */api/orders*<br>
                    Method: ANY<br>
                    Status Code: 500<br>
                    Delay: 1000
                  </div>
                </div>
                <div>
                  <p class="text-xs text-gray-500 mb-1">Response Body:</p>
                  <pre class="font-mono text-xs bg-white p-2 rounded border overflow-x-auto">{
  "error": "Internal Server Error",
  "message": "Database connection failed"
}</pre>
                </div>
              </div>
            </div>

            <!-- Example 4: Slow Network -->
            <div class="p-4 border-l-4 border-blue-500 bg-blue-50 rounded-r-lg">
              <h4 class="font-semibold text-blue-700 mb-2">Example 4: Simulate Slow Network</h4>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <p class="text-xs text-gray-500 mb-1">Configuration:</p>
                  <div class="font-mono text-xs bg-white p-2 rounded border">
                    URL Pattern: */api/*<br>
                    Method: ANY<br>
                    Status Code: 200<br>
                    <strong>Delay: 5000</strong> (5 seconds)
                  </div>
                </div>
                <div>
                  <p class="text-xs text-gray-500 mb-1">Use case:</p>
                  <p class="text-sm text-gray-600">Test how your app handles slow network. Check if loading spinners and timeouts work correctly.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tips -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-yellow-800 mb-3">Tips & Best Practices</h3>
          <ul class="space-y-2 text-sm text-yellow-700">
            <li class="flex items-start gap-2">
              <span class="text-yellow-500">‚Ä¢</span>
              <span><strong>Start with Live Traffic:</strong> Always capture real traffic first to understand the exact URL patterns and response format.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-yellow-500">‚Ä¢</span>
              <span><strong>Use Wildcard patterns:</strong> They're easier to write and more flexible than exact matches.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-yellow-500">‚Ä¢</span>
              <span><strong>Toggle rules on/off:</strong> Quickly enable/disable rules without deleting them.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-yellow-500">‚Ä¢</span>
              <span><strong>Test one rule at a time:</strong> If multiple rules could match, disable others to test specific scenarios.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-yellow-500">‚Ä¢</span>
              <span><strong>Check the purple "Mocked" badge:</strong> In Live Traffic, mocked requests show a purple badge to confirm the rule is working.</span>
            </li>
          </ul>
        </div>
        </div>
      </div>

      <!-- Sub-tab: Real iPhone -->
      <div id="subtab-real-iphone" class="tutorial-subtab-content hidden">
        <div class="space-y-6">
        <!-- Real iPhone Device Setup -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">üì±</span> Real iPhone Device Setup
          </h3>
          <p class="text-gray-600 mb-4">You can also use mitmproxy with your real iPhone. Both devices must be on the same WiFi network.</p>

          <div class="space-y-4">
            <!-- Step 1: Get Mac IP -->
            <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
              <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">1</div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-800">Get Your Mac's IP Address</h4>
                <p class="text-sm text-gray-600 mt-1">Open Terminal and run:</p>
                <code class="block bg-gray-800 text-green-400 p-2 rounded mt-2 text-sm">ipconfig getifaddr en0</code>
                <p class="text-sm text-gray-500 mt-2">Or go to System Preferences ‚Üí Network ‚Üí WiFi ‚Üí look for IP address</p>
                <p class="text-sm text-gray-600 mt-2">Your Mac IP: <span id="macIpAddress" class="font-mono bg-blue-100 px-2 py-1 rounded">Loading...</span></p>
              </div>
            </div>

            <!-- Step 2: Configure iPhone WiFi -->
            <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
              <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">2</div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-800">Configure iPhone WiFi Proxy</h4>
                <p class="text-sm text-gray-600 mt-1">On your iPhone:</p>
                <ol class="text-sm text-gray-600 mt-2 space-y-1 list-decimal list-inside">
                  <li>Go to <strong>Settings ‚Üí WiFi</strong></li>
                  <li>Tap the <strong>‚ìò</strong> icon next to your connected WiFi</li>
                  <li>Scroll down and tap <strong>Configure Proxy</strong></li>
                  <li>Select <strong>Manual</strong></li>
                  <li>Server: <strong><span class="mac-ip">Your Mac IP</span></strong></li>
                  <li>Port: <strong>8888</strong></li>
                  <li>Tap <strong>Save</strong></li>
                </ol>
              </div>
            </div>

            <!-- Step 3: Install Certificate -->
            <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
              <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">3</div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-800">Install mitmproxy Certificate</h4>
                <p class="text-sm text-gray-600 mt-1">On your iPhone (with proxy enabled):</p>
                <ol class="text-sm text-gray-600 mt-2 space-y-1 list-decimal list-inside">
                  <li>Open <strong>Safari</strong> (must be Safari, not Chrome)</li>
                  <li>Go to <strong class="text-blue-600">http://mitm.it</strong></li>
                  <li>Tap <strong>Apple</strong> to download the certificate</li>
                  <li>Tap <strong>Allow</strong> when prompted</li>
                </ol>
              </div>
            </div>

            <!-- Step 4: Install Profile -->
            <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
              <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">4</div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-800">Install the Profile</h4>
                <p class="text-sm text-gray-600 mt-1">On your iPhone:</p>
                <ol class="text-sm text-gray-600 mt-2 space-y-1 list-decimal list-inside">
                  <li>Go to <strong>Settings ‚Üí General ‚Üí VPN & Device Management</strong></li>
                  <li>You'll see <strong>"mitmproxy"</strong> under Downloaded Profile</li>
                  <li>Tap it and tap <strong>Install</strong> (enter passcode)</li>
                  <li>Tap <strong>Install</strong> again to confirm</li>
                </ol>
              </div>
            </div>

            <!-- Step 5: Trust Certificate -->
            <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
              <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">5</div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-800">Enable Full Trust</h4>
                <p class="text-sm text-gray-600 mt-1">This is required for HTTPS interception:</p>
                <ol class="text-sm text-gray-600 mt-2 space-y-1 list-decimal list-inside">
                  <li>Go to <strong>Settings ‚Üí General ‚Üí About</strong></li>
                  <li>Scroll down and tap <strong>Certificate Trust Settings</strong></li>
                  <li>Enable the toggle for <strong>mitmproxy</strong></li>
                  <li>Tap <strong>Continue</strong> to confirm</li>
                </ol>
              </div>
            </div>

            <!-- Step 6: Test -->
            <div class="flex gap-4 p-4 bg-green-50 rounded-lg border border-green-200">
              <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">‚úì</div>
              <div class="flex-1">
                <h4 class="font-semibold text-green-800">Done! Test Your Setup</h4>
                <p class="text-sm text-green-700 mt-1">Open any app on your iPhone and you should see traffic appearing in the <strong>Live Traffic</strong> tab.</p>
                <p class="text-sm text-green-600 mt-2"><strong>To disable:</strong> Go back to WiFi settings and set proxy to "Off"</p>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>

      <!-- Sub-tab: Mac Browser -->
      <div id="subtab-mac-browser" class="tutorial-subtab-content hidden">
        <div class="space-y-6">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
              <span class="text-2xl">üíª</span> Mac Browser Setup
            </h2>
            <p class="text-gray-600">Use mitmproxy to intercept traffic from your Mac's browsers (Chrome, Safari, Firefox).</p>
          </div>

          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Setup Steps</h3>
            <div class="space-y-4">
              <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">1</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">Start the Proxy</h4>
                  <p class="text-sm text-gray-600 mt-1">Click <strong>"Start Proxy"</strong> button in the header.</p>
                </div>
              </div>

              <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">2</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">Enable Mac Proxy</h4>
                  <p class="text-sm text-gray-600 mt-1">Go to <strong>Setup Guide</strong> tab and click <strong>"Enable Mac Proxy"</strong>.</p>
                  <p class="text-sm text-gray-500 mt-1">This automatically configures your Mac's network settings.</p>
                </div>
              </div>

              <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">3</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">Install Certificate (First Time Only)</h4>
                  <p class="text-sm text-gray-600 mt-1">For HTTPS sites, you need to install the mitmproxy certificate:</p>
                  <ol class="text-sm text-gray-600 mt-2 space-y-1 list-decimal list-inside">
                    <li>Open Finder ‚Üí Go ‚Üí Go to Folder ‚Üí <code class="bg-gray-200 px-1 rounded">~/.mitmproxy/</code></li>
                    <li>Double-click <strong>mitmproxy-ca-cert.pem</strong></li>
                    <li>In Keychain Access, select <strong>"System"</strong> keychain</li>
                    <li>Find "mitmproxy", double-click it</li>
                    <li>Expand "Trust" ‚Üí set to <strong>"Always Trust"</strong></li>
                  </ol>
                </div>
              </div>

              <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">4</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">Restart Browser</h4>
                  <p class="text-sm text-gray-600 mt-1">Quit and reopen your browser for the certificate to take effect.</p>
                </div>
              </div>

              <div class="flex gap-4 p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">‚úì</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-green-800">Done!</h4>
                  <p class="text-sm text-green-700 mt-1">Browse any website and see traffic in the <strong>Live Traffic</strong> tab.</p>
                  <p class="text-sm text-green-600 mt-2"><strong>To disable:</strong> Click "Disable Mac Proxy" or "Stop Proxy".</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub-tab: iOS Simulator -->
      <div id="subtab-ios-simulator" class="tutorial-subtab-content hidden">
        <div class="space-y-6">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
              <span class="text-2xl">üì≤</span> iOS Simulator Setup
            </h2>
            <p class="text-gray-600">The iOS Simulator uses your Mac's network settings, making setup simple.</p>
          </div>

          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Setup Steps</h3>
            <div class="space-y-4">
              <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">1</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">Start the Proxy</h4>
                  <p class="text-sm text-gray-600 mt-1">Click <strong>"Start Proxy"</strong> button. This also enables Mac Proxy automatically.</p>
                </div>
              </div>

              <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">2</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">Boot a Simulator</h4>
                  <p class="text-sm text-gray-600 mt-1">Go to <strong>Simulators</strong> tab and boot your desired simulator.</p>
                </div>
              </div>

              <div class="flex gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">3</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">Install Certificate</h4>
                  <p class="text-sm text-gray-600 mt-1">In the Simulator's Safari, go to <strong class="text-blue-600">http://mitm.it</strong></p>
                  <ol class="text-sm text-gray-600 mt-2 space-y-1 list-decimal list-inside">
                    <li>Tap <strong>Apple</strong> to download</li>
                    <li>Go to Settings ‚Üí General ‚Üí VPN & Device Management</li>
                    <li>Install the <strong>mitmproxy</strong> profile</li>
                    <li>Go to Settings ‚Üí General ‚Üí About ‚Üí Certificate Trust Settings</li>
                    <li>Enable trust for <strong>mitmproxy</strong></li>
                  </ol>
                </div>
              </div>

              <div class="flex gap-4 p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">‚úì</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-green-800">Done!</h4>
                  <p class="text-sm text-green-700 mt-1">Run your app in the Simulator. Traffic will appear in <strong>Live Traffic</strong>.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800"><strong>Note:</strong> iOS Simulator shares network settings with your Mac. When Mac Proxy is enabled, the Simulator automatically uses it.</p>
          </div>
        </div>
      </div>

      <!-- Sub-tab: FAQ -->
      <div id="subtab-faq" class="tutorial-subtab-content hidden">
        <div class="space-y-6">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Frequently Asked Questions</h2>
          </div>

          <div class="space-y-4">
            <!-- FAQ 1: Cellular Data -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="font-semibold text-gray-800 mb-3">Can I use the proxy with cellular data on my iPhone?</h3>
              <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                <p class="text-red-800"><strong>No.</strong> The proxy only works when your iPhone is on the same WiFi network as your Mac.</p>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="text-left p-2">Connection</th>
                      <th class="text-left p-2">Works?</th>
                      <th class="text-left p-2">Reason</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <tr>
                      <td class="p-2">Same WiFi</td>
                      <td class="p-2 text-green-600">‚úì Yes</td>
                      <td class="p-2 text-gray-600">iPhone can reach Mac's local IP</td>
                    </tr>
                    <tr>
                      <td class="p-2">Cellular Data</td>
                      <td class="p-2 text-red-600">‚úó No</td>
                      <td class="p-2 text-gray-600">Can't reach private IP from internet</td>
                    </tr>
                    <tr>
                      <td class="p-2">Different WiFi</td>
                      <td class="p-2 text-red-600">‚úó No</td>
                      <td class="p-2 text-gray-600">Different network, can't reach Mac</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- FAQ 2: No Internet -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="font-semibold text-gray-800 mb-3">Why do I get "No Internet" when proxy is enabled?</h3>
              <p class="text-gray-600 mb-3">This happens when Mac Proxy is enabled but mitmproxy is not running.</p>
              <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                <p class="text-yellow-800"><strong>Solution:</strong> Always start the proxy first, then enable Mac Proxy. If you stop the proxy, Mac Proxy is automatically disabled.</p>
              </div>
            </div>

            <!-- FAQ 3: HTTPS Not Working -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="font-semibold text-gray-800 mb-3">Why can't I access HTTPS websites?</h3>
              <p class="text-gray-600 mb-3">You need to install and trust the mitmproxy certificate.</p>
              <ul class="text-sm text-gray-600 space-y-1 list-disc list-inside">
                <li>For Mac: Install certificate in Keychain and set to "Always Trust"</li>
                <li>For iPhone: Install profile AND enable in Certificate Trust Settings</li>
                <li>Restart your browser after installing the certificate</li>
              </ul>
            </div>

            <!-- FAQ 4: Traffic Not Showing -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="font-semibold text-gray-800 mb-3">Why don't I see any traffic in Live Traffic?</h3>
              <p class="text-gray-600 mb-3">Check the following:</p>
              <ul class="text-sm text-gray-600 space-y-1 list-disc list-inside">
                <li>Is the proxy running? (Check header status)</li>
                <li>Is Mac Proxy enabled? (Check Setup Guide tab)</li>
                <li>For real iPhone: Is the WiFi proxy configured correctly?</li>
                <li>Is the certificate installed and trusted?</li>
              </ul>
            </div>

            <!-- FAQ 5: Mock Not Working -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="font-semibold text-gray-800 mb-3">Why isn't my mock rule working?</h3>
              <p class="text-gray-600 mb-3">Check the following:</p>
              <ul class="text-sm text-gray-600 space-y-1 list-disc list-inside">
                <li>Is the rule enabled? (Toggle should be on)</li>
                <li>Does the URL pattern match? (Check Live Traffic for exact URL)</li>
                <li>Is the HTTP method correct? (GET, POST, etc.)</li>
                <li>Try using wildcard pattern: <code class="bg-gray-200 px-1 rounded">*/your/api/*</code></li>
              </ul>
            </div>

            <!-- FAQ 6: Multiple Devices -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="font-semibold text-gray-800 mb-3">Can I use multiple devices at the same time?</h3>
              <div class="bg-green-50 border-l-4 border-green-500 p-4">
                <p class="text-green-800"><strong>Yes!</strong> Multiple devices can connect to the same proxy. Just configure each device to use your Mac's IP and port 8888.</p>
              </div>
            </div>

            <!-- FAQ 7: Office WiFi -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="font-semibold text-gray-800 mb-3">Will my mock rules affect other users on the same WiFi (office/home)?</h3>
              <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                <p class="text-green-800"><strong>No!</strong> Only devices you explicitly configure to use your Mac as a proxy will be affected.</p>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="text-left p-2">Device</th>
                      <th class="text-left p-2">Configured?</th>
                      <th class="text-left p-2">Gets Mocked?</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <tr>
                      <td class="p-2">Your iPhone (proxy set to your Mac)</td>
                      <td class="p-2 text-green-600">‚úì Yes</td>
                      <td class="p-2 text-green-600">‚úì Yes</td>
                    </tr>
                    <tr>
                      <td class="p-2">Your Mac (Mac Proxy enabled)</td>
                      <td class="p-2 text-green-600">‚úì Yes</td>
                      <td class="p-2 text-green-600">‚úì Yes</td>
                    </tr>
                    <tr>
                      <td class="p-2">Colleague's phone</td>
                      <td class="p-2 text-gray-600">‚úó No</td>
                      <td class="p-2 text-gray-600">‚úó No - Normal internet</td>
                    </tr>
                    <tr>
                      <td class="p-2">Other office devices</td>
                      <td class="p-2 text-gray-600">‚úó No</td>
                      <td class="p-2 text-gray-600">‚úó No - Normal internet</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <p class="text-sm text-gray-500 mt-3">Your coworkers won't even know you're running a proxy - their devices connect directly to the internet.</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Rule Modal -->
  <div id="ruleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden m-4 flex flex-col">
      <!-- Header -->
      <div class="p-4 border-b flex items-center justify-between bg-gray-50 flex-shrink-0">
        <h3 class="font-semibold text-lg" id="ruleModalTitle">Add Mock Rule</h3>
        <button onclick="hideRuleModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
      </div>

      <!-- Scrollable Content -->
      <form id="ruleForm" onsubmit="saveRule(event)" class="flex-1 overflow-y-auto">
        <div class="p-6 space-y-6">
          <input type="hidden" id="ruleId">

          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <input type="text" id="ruleDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Mock user login error response">
          </div>

          <!-- Request Matching Section -->
          <div class="bg-gray-50 rounded-lg p-4 space-y-4">
            <h4 class="font-medium text-gray-800 flex items-center gap-2">
              <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              Request Matching
            </h4>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">URL Pattern</label>
              <input type="text" id="ruleUrlPattern" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="*/api/users/* or https://example.com/api/login" required>
            </div>

            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Pattern Type</label>
                <select id="rulePatternType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="wildcard">Wildcard (*)</option>
                  <option value="exact">Exact Match</option>
                  <option value="regex">Regex</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">HTTP Method</label>
                <select id="ruleMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="ANY">ANY</option>
                  <option value="GET">GET</option>
                  <option value="POST">POST</option>
                  <option value="PUT">PUT</option>
                  <option value="DELETE">DELETE</option>
                  <option value="PATCH">PATCH</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Delay (ms)</label>
                <input type="number" id="ruleDelay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="0" min="0" max="30000" placeholder="0">
              </div>
            </div>
          </div>

          <!-- Response Section -->
          <div class="bg-blue-50 rounded-lg p-4 space-y-4">
            <h4 class="font-medium text-gray-800 flex items-center gap-2">
              <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Mock Response
            </h4>

            <div class="grid grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status Code</label>
                <input type="number" id="ruleStatusCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="200" min="100" max="599">
              </div>
              <div class="col-span-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quick Status</label>
                <div class="flex gap-2">
                  <button type="button" onclick="document.getElementById('ruleStatusCode').value=200" class="px-3 py-2 bg-green-100 text-green-700 text-sm rounded-lg hover:bg-green-200">200 OK</button>
                  <button type="button" onclick="document.getElementById('ruleStatusCode').value=201" class="px-3 py-2 bg-green-100 text-green-700 text-sm rounded-lg hover:bg-green-200">201</button>
                  <button type="button" onclick="document.getElementById('ruleStatusCode').value=400" class="px-3 py-2 bg-yellow-100 text-yellow-700 text-sm rounded-lg hover:bg-yellow-200">400</button>
                  <button type="button" onclick="document.getElementById('ruleStatusCode').value=401" class="px-3 py-2 bg-yellow-100 text-yellow-700 text-sm rounded-lg hover:bg-yellow-200">401</button>
                  <button type="button" onclick="document.getElementById('ruleStatusCode').value=404" class="px-3 py-2 bg-orange-100 text-orange-700 text-sm rounded-lg hover:bg-orange-200">404</button>
                  <button type="button" onclick="document.getElementById('ruleStatusCode').value=500" class="px-3 py-2 bg-red-100 text-red-700 text-sm rounded-lg hover:bg-red-200">500</button>
                </div>
              </div>
            </div>

            <!-- Headers -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700">Response Headers (JSON)</label>
                <button type="button" onclick="formatJson('ruleHeaders')" class="text-xs px-2 py-1 bg-gray-200 text-gray-600 rounded hover:bg-gray-300">Format JSON</button>
              </div>
              <textarea id="ruleHeaders" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" spellcheck="false">{"Content-Type": "application/json"}</textarea>
            </div>

            <!-- Body -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700">Response Body</label>
                <div class="flex gap-2">
                  <button type="button" onclick="formatJson('ruleBody')" class="text-xs px-2 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 font-medium">Format JSON</button>
                  <button type="button" onclick="minifyJson('ruleBody')" class="text-xs px-2 py-1 bg-gray-200 text-gray-600 rounded hover:bg-gray-300">Minify</button>
                </div>
              </div>
              <textarea id="ruleBody" class="w-full px-3 py-3 border border-gray-300 rounded-lg font-mono text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent leading-relaxed" rows="12" placeholder='{"message": "Mocked response", "data": {...}}' spellcheck="false"></textarea>
              <p class="text-xs text-gray-400 mt-1">Tip: Click "Format JSON" to prettify the response body for easier editing</p>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-3 p-4 border-t bg-gray-50 flex-shrink-0">
          <button type="button" onclick="hideRuleModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition">Cancel</button>
          <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium">Save Rule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Traffic Detail Modal -->
  <div id="trafficModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
      <div class="p-4 border-b flex items-center justify-between sticky top-0 bg-white">
        <h3 class="font-semibold">Request Details</h3>
        <div class="flex gap-2">
          <button onclick="createRuleFromTraffic()" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">Create Mock Rule</button>
          <button onclick="hideTrafficModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>
      </div>
      <div id="trafficDetail" class="p-4"></div>
    </div>
  </div>

  <script>
    // State
    let proxyRunning = false;
    let isRecording = false;
    let trafficData = [];
    let trafficPaused = false;
    let selectedFilters = []; // Array of selected host filters
    let searchQuery = ''; // Search keyword
    let rulesData = [];
    let selectedTraffic = null;
    let ws = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      connectWebSocket();
      loadSimulators();
      loadRules();
      loadRecordings();
      checkMacProxyStatus();
      loadMacIP();
      loadSavedFilter();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('baseUrlDropdown');
      const toggle = e.target.closest('[onclick*="toggleBaseUrlDropdown"]');
      if (!toggle && !e.target.closest('#baseUrlDropdown')) {
        dropdown?.classList.add('hidden');
      }
    });

    // Load Mac IP address for real device tutorial
    async function loadMacIP() {
      try {
        const res = await fetch('/api/mac-ip');
        const data = await res.json();
        const ipDisplay = document.getElementById('macIpAddress');
        if (ipDisplay) {
          ipDisplay.textContent = data.ip;
        }
        // Also update any elements with class mac-ip
        document.querySelectorAll('.mac-ip').forEach(el => {
          el.textContent = data.ip;
        });
      } catch (err) {
        console.error('Failed to load Mac IP:', err);
      }
    }

    // WebSocket connection
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleWebSocketMessage(msg);
      };

      ws.onclose = () => {
        setTimeout(connectWebSocket, 3000);
      };
    }

    function handleWebSocketMessage(msg) {
      switch (msg.type) {
        case 'status':
          updateProxyStatus(msg.data.proxy);
          if (msg.data.recording) {
            isRecording = msg.data.recording.isRecording;
            updateRecordingUI();
          }
          break;
        case 'traffic':
          addTrafficItem(msg.data);
          break;
        case 'history':
          trafficData = msg.data;
          renderTraffic();
          break;
        case 'historyCleared':
          trafficData = [];
          renderTraffic();
          break;
        case 'rulesUpdated':
          rulesData = msg.data;
          renderRules();
          break;
        case 'recordingStarted':
          isRecording = true;
          updateRecordingUI();
          break;
        case 'recordingStopped':
          isRecording = false;
          updateRecordingUI();
          loadRecordings();
          break;
      }
    }

    // Proxy control
    async function toggleProxy() {
      const endpoint = proxyRunning ? '/api/proxy/stop' : '/api/proxy/start';
      try {
        // If stopping proxy, disable Mac proxy first to prevent "no internet" issue
        if (proxyRunning) {
          await fetch('/api/mac-proxy/disable', { method: 'POST' });
        }
        const res = await fetch(endpoint, { method: 'POST' });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        // If starting proxy, enable Mac proxy automatically
        if (!proxyRunning) {
          await fetch('/api/mac-proxy/enable', { method: 'POST' });
        }
        checkMacProxyStatus(); // Refresh status display
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function updateProxyStatus(status) {
      proxyRunning = status.running;
      const dot = document.getElementById('proxyStatus');
      const text = document.getElementById('proxyStatusText');
      const btn = document.getElementById('toggleProxy');

      if (proxyRunning) {
        dot.className = 'status-dot status-running';
        text.textContent = `Proxy Running (PID: ${status.pid})`;
        btn.textContent = 'Stop Proxy';
        btn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition';
      } else {
        dot.className = 'status-dot status-stopped';
        text.textContent = 'Proxy Stopped';
        btn.textContent = 'Start Proxy';
        btn.className = 'px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition';
      }
    }

    // Mac proxy control
    async function enableMacProxy() {
      try {
        const res = await fetch('/api/mac-proxy/enable', { method: 'POST' });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        checkMacProxyStatus();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function disableMacProxy() {
      try {
        const res = await fetch('/api/mac-proxy/disable', { method: 'POST' });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        checkMacProxyStatus();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function checkMacProxyStatus() {
      try {
        const res = await fetch('/api/mac-proxy/status');
        const data = await res.json();
        const statusEl = document.getElementById('macProxyStatus');
        if (data.http?.enabled || data.https?.enabled) {
          statusEl.textContent = `Status: Enabled (${data.http?.server}:${data.http?.port})`;
          statusEl.className = 'text-xs text-green-600';
        } else {
          statusEl.textContent = 'Status: Disabled';
          statusEl.className = 'text-xs text-red-600';
        }
      } catch (err) {
        console.error(err);
      }
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-blue-500', 'text-blue-600');
        el.classList.add('border-transparent', 'text-gray-500');
      });

      document.getElementById(`tab-${tabName}`).classList.add('active');
      const btn = document.querySelector(`[data-tab="${tabName}"]`);
      btn.classList.remove('border-transparent', 'text-gray-500');
      btn.classList.add('border-blue-500', 'text-blue-600');
    }

    function switchTutorialSubTab(subTabName) {
      // Hide all sub-tab contents
      document.querySelectorAll('.tutorial-subtab-content').forEach(el => el.classList.add('hidden'));
      // Reset all sub-tab buttons
      document.querySelectorAll('.tutorial-sub-tab').forEach(el => {
        el.classList.remove('border-blue-500', 'text-blue-600');
        el.classList.add('border-transparent', 'text-gray-500');
      });

      // Show selected sub-tab
      document.getElementById(`subtab-${subTabName}`).classList.remove('hidden');
      const btn = document.querySelector(`[data-subtab="${subTabName}"]`);
      btn.classList.remove('border-transparent', 'text-gray-500');
      btn.classList.add('border-blue-500', 'text-blue-600');
    }

    // Setup steps
    function markStepComplete(stepNum) {
      const step = document.getElementById(`step-${stepNum}`);
      step.classList.add('completed');
    }

    // Simulators
    async function loadSimulators() {
      try {
        const res = await fetch('/api/simulators');
        const simulators = await res.json();
        renderSimulators(simulators);

        // Update quick select dropdown
        const select = document.getElementById('quickSimulatorSelect');
        select.innerHTML = '<option value="">Select simulator...</option>' +
          simulators
            .filter(s => s.isAvailable)
            .map(s => `<option value="${s.udid}" ${s.state === 'booted' ? 'selected' : ''}>${s.name} (${s.os}) ${s.state === 'booted' ? '- Booted' : ''}</option>`)
            .join('');
      } catch (err) {
        console.error(err);
      }
    }

    function renderSimulators(simulators) {
      const container = document.getElementById('simulatorsList');
      if (simulators.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400">No simulators found</div>';
        return;
      }

      container.innerHTML = simulators
        .filter(s => s.isAvailable)
        .map(s => `
          <div class="p-4 flex items-center justify-between hover:bg-gray-50">
            <div>
              <div class="font-medium">${s.name}</div>
              <div class="text-sm text-gray-500">${s.os} - ${s.udid.slice(0, 8)}...</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 text-xs rounded ${s.state === 'booted' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">${s.state}</span>
              ${s.state === 'booted'
                ? `<button onclick="shutdownSimulator('${s.udid}')" class="px-3 py-1 bg-red-100 text-red-600 text-sm rounded hover:bg-red-200">Shutdown</button>`
                : `<button onclick="bootSimulator('${s.udid}')" class="px-3 py-1 bg-green-100 text-green-600 text-sm rounded hover:bg-green-200">Boot</button>`
              }
            </div>
          </div>
        `).join('');
    }

    async function bootSimulator(udid) {
      try {
        const res = await fetch('/api/simulators/boot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ udid })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        loadSimulators();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function shutdownSimulator(udid) {
      try {
        const res = await fetch('/api/simulators/shutdown', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ udid })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        loadSimulators();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function bootSelectedSimulator() {
      const select = document.getElementById('quickSimulatorSelect');
      if (select.value) {
        bootSimulator(select.value);
      } else {
        alert('Please select a simulator first');
      }
    }

    // Traffic
    function addTrafficItem(item) {
      trafficData.push(item);
      if (trafficData.length > 500) trafficData.shift();
      if (!trafficPaused) {
        renderTraffic();
      }
    }

    function toggleTrafficPause() {
      trafficPaused = !trafficPaused;
      const btn = document.getElementById('trafficPauseBtn');
      const icon = document.getElementById('trafficPauseIcon');
      const text = document.getElementById('trafficPauseText');

      if (trafficPaused) {
        btn.classList.remove('bg-green-500', 'hover:bg-green-600');
        btn.classList.add('bg-amber-500', 'hover:bg-amber-600');
        icon.textContent = '‚ñ∂';
        text.textContent = 'Resume';
      } else {
        btn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
        btn.classList.add('bg-green-500', 'hover:bg-green-600');
        icon.textContent = '‚è∏';
        text.textContent = 'Pause';
        renderTraffic(); // Refresh to show any items added while paused
      }
    }

    function renderTraffic() {
      const container = document.getElementById('trafficList');

      // Store filtered items with their original indices
      const filtered = trafficData
        .map((t, originalIndex) => ({ ...t, _originalIndex: originalIndex }))
        .filter(t => {
          const urlLower = t.url.toLowerCase();

          // Apply host filters
          if (selectedFilters.length > 0) {
            const matchesFilter = selectedFilters.some(f => urlLower.includes(f.toLowerCase()));
            if (!matchesFilter) return false;
          }

          // Apply search query
          if (searchQuery) {
            const query = searchQuery.toLowerCase();
            // Search in URL, method, and response status
            const matchesSearch = urlLower.includes(query) ||
              t.method.toLowerCase().includes(query) ||
              (t.response?.status?.toString() || '').includes(query);
            if (!matchesSearch) return false;
          }

          return true;
        });

      document.getElementById('trafficCount').textContent = `${filtered.length} requests`;

      // Update filter tags display
      updateFilterTags();

      if (filtered.length === 0) {
        const message = (searchQuery || selectedFilters.length > 0)
          ? 'No requests match your filters.'
          : 'No traffic captured yet.';
        container.innerHTML = `<div class="p-8 text-center text-gray-400">${message}</div>`;
        return;
      }

      container.innerHTML = filtered.slice().reverse().map((t, i) => {
        const statusClass = t.response
          ? (t.response.status < 300 ? 'status-2xx' : t.response.status < 400 ? 'status-3xx' : t.response.status < 500 ? 'status-4xx' : 'status-5xx')
          : '';
        const methodClass = `method-${t.method.toLowerCase()}`;

        return `
          <div class="traffic-item p-3 cursor-pointer flex items-center gap-4" onclick="showTrafficDetail(${t._originalIndex})">
            <span class="font-mono text-sm font-bold w-16 ${methodClass}">${t.method}</span>
            <span class="font-mono text-sm ${statusClass} w-12">${t.response?.status || '-'}</span>
            <span class="flex-1 text-sm truncate ${t.mocked ? 'text-purple-600' : ''}">${t.url}</span>
            ${t.mocked ? '<span class="px-2 py-0.5 bg-purple-100 text-purple-600 text-xs rounded">Mocked</span>' : ''}
            <span class="text-xs text-gray-400">${t.duration ? t.duration + 'ms' : ''}</span>
          </div>
        `;
      }).join('');
    }

    function filterTraffic() {
      // Save filters to localStorage
      localStorage.setItem('selectedFilters', JSON.stringify(selectedFilters));
      renderTraffic();
    }

    // Search functions
    function onSearchInput() {
      const input = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearchBtn');

      searchQuery = input.value.trim();

      // Show/hide clear button
      if (searchQuery) {
        clearBtn.classList.remove('hidden');
      } else {
        clearBtn.classList.add('hidden');
      }

      renderTraffic();
    }

    function clearSearch() {
      const input = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearchBtn');

      input.value = '';
      searchQuery = '';
      clearBtn.classList.add('hidden');
      renderTraffic();
    }

    function updateFilterTags() {
      const tagsContainer = document.getElementById('filterTags');
      const tagsRow = document.getElementById('filterTagsRow');
      const filterCount = document.getElementById('filterCount');

      if (selectedFilters.length === 0) {
        tagsRow.classList.add('hidden');
        filterCount.classList.add('hidden');
        return;
      }

      // Show the tags row and update count badge
      tagsRow.classList.remove('hidden');
      filterCount.classList.remove('hidden');
      filterCount.textContent = selectedFilters.length;

      // Get custom patterns to style them differently
      const customPatterns = JSON.parse(localStorage.getItem('customFilterPatterns') || '[]');
      const customPatternsLower = customPatterns.map(p => p.toLowerCase());

      tagsContainer.innerHTML = selectedFilters.map(f => {
        const isCustom = customPatternsLower.includes(f.toLowerCase());
        if (isCustom) {
          return `
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 text-sm rounded-full">
              ${escapeHtml(f)}
              <button onclick="removeFilter('${escapeHtml(f)}')" class="hover:text-purple-900 font-bold">√ó</button>
            </span>
          `;
        }
        return `
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-sm rounded-full">
            ${escapeHtml(f)}
            <button onclick="removeFilter('${escapeHtml(f)}')" class="hover:text-blue-900 font-bold">√ó</button>
          </span>
        `;
      }).join('');
    }

    function removeFilter(filterToRemove) {
      selectedFilters = selectedFilters.filter(f => f.toLowerCase() !== filterToRemove.toLowerCase());
      filterTraffic();
      updateBaseUrlList();
    }

    function clearAllFilters() {
      selectedFilters = [];
      localStorage.removeItem('selectedFilters');
      renderTraffic();
      updateBaseUrlList();
      // Close dropdown after clearing
      document.getElementById('baseUrlDropdown').classList.add('hidden');
    }

    function toggleBaseUrlDropdown() {
      const dropdown = document.getElementById('baseUrlDropdown');
      dropdown.classList.toggle('hidden');
      if (!dropdown.classList.contains('hidden')) {
        updateBaseUrlList();
      }
    }

    function updateBaseUrlList() {
      const container = document.getElementById('baseUrlList');

      // Get custom patterns
      const customPatterns = JSON.parse(localStorage.getItem('customFilterPatterns') || '[]');

      // Extract unique hosts from traffic data
      const hosts = new Set();
      trafficData.forEach(t => {
        try {
          const url = new URL(t.url);
          hosts.add(url.host);
        } catch (e) {}
      });

      // Also add saved hosts from localStorage
      const savedHosts = JSON.parse(localStorage.getItem('savedHosts') || '[]');
      savedHosts.forEach(h => hosts.add(h));

      let html = '';

      // Show custom patterns first (with purple styling and delete button)
      if (customPatterns.length > 0) {
        html += '<div class="px-3 py-1.5 bg-purple-50 border-b"><span class="text-xs font-medium text-purple-600">Custom Patterns</span></div>';
        html += customPatterns.map(pattern => {
          const isActive = selectedFilters.some(f => f.toLowerCase() === pattern.toLowerCase());
          return `
            <div class="px-3 py-2 text-sm flex items-center justify-between ${isActive ? 'bg-purple-50' : 'hover:bg-gray-50'}">
              <div class="flex items-center gap-2 cursor-pointer flex-1" onclick="toggleHostFilter('${escapeHtml(pattern)}')">
                <span class="${isActive ? 'text-purple-700 font-medium' : 'text-purple-600'}">${escapeHtml(pattern)}</span>
                <span class="text-xs px-1.5 py-0.5 bg-purple-100 text-purple-500 rounded">pattern</span>
              </div>
              <div class="flex items-center gap-2">
                ${isActive ? '<span class="text-purple-500">‚úì</span>' : '<span class="text-gray-300">‚óã</span>'}
                <button onclick="event.stopPropagation(); removeCustomPattern('${escapeHtml(pattern)}')" class="text-gray-400 hover:text-red-500 ml-1" title="Remove pattern">√ó</button>
              </div>
            </div>
          `;
        }).join('');
      }

      // Show auto-detected hosts
      if (hosts.size > 0) {
        if (customPatterns.length > 0) {
          html += '<div class="px-3 py-1.5 bg-gray-50 border-b border-t"><span class="text-xs font-medium text-gray-500">Detected Hosts</span></div>';
        }
        html += Array.from(hosts).sort().map(host => {
          const isActive = selectedFilters.some(f => f.toLowerCase() === host.toLowerCase());
          return `
            <div class="px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 flex items-center justify-between ${isActive ? 'bg-blue-50' : ''}" onclick="toggleHostFilter('${escapeHtml(host)}')">
              <span class="${isActive ? 'text-blue-700 font-medium' : ''}">${escapeHtml(host)}</span>
              ${isActive ? '<span class="text-blue-500">‚úì</span>' : '<span class="text-gray-300">‚óã</span>'}
            </div>
          `;
        }).join('');
      }

      if (!html) {
        html = '<div class="p-3 text-sm text-gray-400">No hosts detected yet. Add a custom pattern above.</div>';
      }

      container.innerHTML = html;
    }

    function toggleHostFilter(host) {
      const hostLower = host.toLowerCase();
      const existingIndex = selectedFilters.findIndex(f => f.toLowerCase() === hostLower);

      if (existingIndex >= 0) {
        // Remove the host
        selectedFilters.splice(existingIndex, 1);
      } else {
        // Add the host
        selectedFilters.push(host);
        // Save host to localStorage for future dropdown
        const savedHosts = JSON.parse(localStorage.getItem('savedHosts') || '[]');
        if (!savedHosts.includes(host)) {
          savedHosts.push(host);
          localStorage.setItem('savedHosts', JSON.stringify(savedHosts));
        }
      }

      filterTraffic();
      updateBaseUrlList();
    }

    function addCustomFilter() {
      const input = document.getElementById('customFilterInput');
      const pattern = input.value.trim();

      if (!pattern) return;

      // Check if already exists
      if (selectedFilters.some(f => f.toLowerCase() === pattern.toLowerCase())) {
        input.value = '';
        return;
      }

      // Add to filters
      selectedFilters.push(pattern);

      // Save to custom patterns localStorage (separate from auto-detected hosts)
      const customPatterns = JSON.parse(localStorage.getItem('customFilterPatterns') || '[]');
      if (!customPatterns.some(p => p.toLowerCase() === pattern.toLowerCase())) {
        customPatterns.push(pattern);
        localStorage.setItem('customFilterPatterns', JSON.stringify(customPatterns));
      }

      input.value = '';
      filterTraffic();
      updateBaseUrlList();
    }

    function removeCustomPattern(pattern) {
      // Remove from custom patterns localStorage
      const customPatterns = JSON.parse(localStorage.getItem('customFilterPatterns') || '[]');
      const filtered = customPatterns.filter(p => p.toLowerCase() !== pattern.toLowerCase());
      localStorage.setItem('customFilterPatterns', JSON.stringify(filtered));

      // Also remove from active filters
      selectedFilters = selectedFilters.filter(f => f.toLowerCase() !== pattern.toLowerCase());
      filterTraffic();
      updateBaseUrlList();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load saved filters on page load
    function loadSavedFilter() {
      const saved = localStorage.getItem('selectedFilters');
      if (saved) {
        try {
          selectedFilters = JSON.parse(saved);
        } catch (e) {
          selectedFilters = [];
        }
      }
      updateFilterTags();
    }

    async function clearTraffic() {
      try {
        await fetch('/api/traffic/history', { method: 'DELETE' });
        trafficData = [];
        renderTraffic();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function showTrafficDetail(index) {
      selectedTraffic = trafficData[index];
      const t = selectedTraffic;

      const detail = document.getElementById('trafficDetail');
      detail.innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div><span class="text-gray-500">Method:</span> <span class="font-mono font-bold">${t.method}</span></div>
            <div><span class="text-gray-500">Status:</span> <span class="font-mono">${t.response?.status || '-'}</span></div>
            <div><span class="text-gray-500">Duration:</span> <span class="font-mono">${t.duration || '-'}ms</span></div>
            <div><span class="text-gray-500">Size:</span> <span class="font-mono">${t.response?.size || '-'} bytes</span></div>
          </div>

          <div>
            <span class="text-gray-500">URL:</span>
            <div class="font-mono text-sm break-all bg-gray-50 p-2 rounded mt-1">${t.url}</div>
          </div>

          <details>
            <summary class="font-medium cursor-pointer">Request Headers</summary>
            <pre class="mt-2 p-3 bg-gray-800 text-green-400 text-xs rounded overflow-x-auto">${JSON.stringify(t.requestHeaders || {}, null, 2)}</pre>
          </details>

          ${t.requestBody ? `
            <details>
              <summary class="font-medium cursor-pointer">Request Body</summary>
              <pre class="mt-2 p-3 bg-gray-800 text-green-400 text-xs rounded overflow-x-auto">${formatBody(t.requestBody)}</pre>
            </details>
          ` : ''}

          <details open>
            <summary class="font-medium cursor-pointer">Response Headers</summary>
            <pre class="mt-2 p-3 bg-gray-800 text-green-400 text-xs rounded overflow-x-auto">${JSON.stringify(t.response?.headers || {}, null, 2)}</pre>
          </details>

          <details open>
            <summary class="font-medium cursor-pointer">Response Body</summary>
            <pre class="mt-2 p-3 bg-gray-800 text-green-400 text-xs rounded overflow-x-auto max-h-96 overflow-y-auto">${formatBody(t.response?.body)}</pre>
          </details>

          <details>
            <summary class="font-medium cursor-pointer">cURL Command</summary>
            <div class="mt-2 relative">
              <pre id="curlCommand" class="p-3 bg-gray-800 text-green-400 text-xs rounded overflow-x-auto">${generateCurl(t)}</pre>
              <button onclick="copyCurl(this)" class="absolute top-2 right-2 px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded">
                Copy
              </button>
            </div>
          </details>
        </div>
      `;

      document.getElementById('trafficModal').classList.remove('hidden');
      document.getElementById('trafficModal').classList.add('flex');
    }

    function hideTrafficModal() {
      document.getElementById('trafficModal').classList.add('hidden');
      document.getElementById('trafficModal').classList.remove('flex');
    }

    function formatBody(body) {
      if (!body) return '(empty)';
      try {
        return JSON.stringify(JSON.parse(body), null, 2);
      } catch {
        return body;
      }
    }

    function generateCurl(t) {
      let curl = `curl -X ${t.method} '${t.url}'`;

      // Add headers
      if (t.requestHeaders) {
        for (const [key, value] of Object.entries(t.requestHeaders)) {
          // Skip some headers that curl handles automatically
          if (['host', 'content-length', 'connection'].includes(key.toLowerCase())) continue;
          curl += ` \\\n  -H '${key}: ${value.replace(/'/g, "'\\''")}'`;
        }
      }

      // Add body for POST/PUT/PATCH
      if (t.requestBody && ['POST', 'PUT', 'PATCH'].includes(t.method)) {
        const escapedBody = t.requestBody.replace(/'/g, "'\\''");
        curl += ` \\\n  -d '${escapedBody}'`;
      }

      return curl;
    }

    function copyCurl(btn) {
      const curlText = document.getElementById('curlCommand').textContent;
      navigator.clipboard.writeText(curlText).then(() => {
        // Show feedback
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.add('bg-green-600');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('bg-green-600');
        }, 1500);
      }).catch(err => {
        alert('Failed to copy: ' + err.message);
      });
    }

    // Rules
    async function loadRules() {
      try {
        const res = await fetch('/api/rules');
        rulesData = await res.json();
        renderRules();
      } catch (err) {
        console.error(err);
      }
    }

    function renderRules() {
      const container = document.getElementById('rulesList');
      if (rulesData.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400">No mock rules configured.</div>';
        return;
      }

      container.innerHTML = rulesData.map(r => `
        <div class="p-4 flex items-center gap-4 hover:bg-gray-50 border-l-4 ${r.enabled ? 'border-green-500 bg-green-50/30' : 'border-gray-300 bg-gray-50/50'}">
          <!-- Toggle Switch -->
          <button onclick="toggleRule('${r.id}')" class="flex-shrink-0 relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${r.enabled ? 'bg-green-500' : 'bg-gray-300'}" title="${r.enabled ? 'Click to disable' : 'Click to enable'}">
            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform shadow ${r.enabled ? 'translate-x-6' : 'translate-x-1'}"></span>
          </button>
          <!-- Rule Info -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="font-medium ${r.enabled ? 'text-gray-900' : 'text-gray-500'}">${escapeHtml(r.description || 'Untitled Rule')}</span>
              ${r.enabled ? '<span class="px-1.5 py-0.5 bg-green-100 text-green-700 text-xs rounded font-medium">ACTIVE</span>' : '<span class="px-1.5 py-0.5 bg-gray-200 text-gray-500 text-xs rounded">OFF</span>'}
            </div>
            <div class="text-sm text-gray-500 mt-1 flex items-center gap-2 flex-wrap">
              <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded font-mono">${r.method}</span>
              <span class="font-mono text-xs truncate max-w-md">${escapeHtml(r.urlPattern)}</span>
              <span class="text-gray-400">‚Üí</span>
              <span class="px-1.5 py-0.5 ${r.statusCode < 300 ? 'bg-green-100 text-green-700' : r.statusCode < 400 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'} text-xs rounded font-mono">${r.statusCode}</span>
              ${r.delay ? `<span class="text-xs text-gray-400">(${r.delay}ms delay)</span>` : ''}
            </div>
          </div>
          <!-- Actions -->
          <div class="flex items-center gap-2 flex-shrink-0">
            <button onclick="editRule('${r.id}')" class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">Edit</button>
            <button onclick="deleteRule('${r.id}')" class="px-3 py-1.5 bg-red-100 text-red-600 text-sm rounded hover:bg-red-200">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function showRuleModal(rule = null) {
      document.getElementById('ruleModalTitle').textContent = rule ? 'Edit Mock Rule' : 'Add Mock Rule';
      document.getElementById('ruleId').value = rule?.id || '';
      document.getElementById('ruleDescription').value = rule?.description || '';
      document.getElementById('ruleUrlPattern').value = rule?.urlPattern || '';
      document.getElementById('rulePatternType').value = rule?.urlPatternType || 'wildcard';
      document.getElementById('ruleMethod').value = rule?.method || 'ANY';
      document.getElementById('ruleStatusCode').value = rule?.statusCode || 200;
      document.getElementById('ruleHeaders').value = JSON.stringify(rule?.headers || { 'Content-Type': 'application/json' }, null, 2);
      document.getElementById('ruleDelay').value = rule?.delay || 0;

      // Format body as pretty JSON if possible
      let bodyValue = '';
      if (rule?.body) {
        if (typeof rule.body === 'object') {
          bodyValue = JSON.stringify(rule.body, null, 2);
        } else {
          // Try to parse and format if it's a JSON string
          try {
            const parsed = JSON.parse(rule.body);
            bodyValue = JSON.stringify(parsed, null, 2);
          } catch {
            bodyValue = rule.body;
          }
        }
      }
      document.getElementById('ruleBody').value = bodyValue;

      document.getElementById('ruleModal').classList.remove('hidden');
      document.getElementById('ruleModal').classList.add('flex');
    }

    function hideRuleModal() {
      document.getElementById('ruleModal').classList.add('hidden');
      document.getElementById('ruleModal').classList.remove('flex');
    }

    function formatJson(textareaId) {
      const textarea = document.getElementById(textareaId);
      try {
        const parsed = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(parsed, null, 2);
      } catch (e) {
        alert('Invalid JSON: ' + e.message);
      }
    }

    function minifyJson(textareaId) {
      const textarea = document.getElementById(textareaId);
      try {
        const parsed = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(parsed);
      } catch (e) {
        alert('Invalid JSON: ' + e.message);
      }
    }

    async function saveRule(event) {
      event.preventDefault();

      const id = document.getElementById('ruleId').value;
      let headers;
      try {
        headers = JSON.parse(document.getElementById('ruleHeaders').value);
      } catch {
        alert('Invalid JSON in headers');
        return;
      }

      const ruleData = {
        description: document.getElementById('ruleDescription').value,
        urlPattern: document.getElementById('ruleUrlPattern').value,
        urlPatternType: document.getElementById('rulePatternType').value,
        method: document.getElementById('ruleMethod').value,
        statusCode: parseInt(document.getElementById('ruleStatusCode').value),
        headers,
        body: document.getElementById('ruleBody').value,
        delay: parseInt(document.getElementById('ruleDelay').value) || 0
      };

      try {
        const url = id ? `/api/rules/${id}` : '/api/rules';
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ruleData)
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        hideRuleModal();
        loadRules();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function toggleRule(id) {
      try {
        await fetch(`/api/rules/${id}/toggle`, { method: 'POST' });
        loadRules();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function editRule(id) {
      const rule = rulesData.find(r => r.id === id);
      if (rule) showRuleModal(rule);
    }

    async function deleteRule(id) {
      if (!confirm('Are you sure you want to delete this rule?')) return;
      try {
        await fetch(`/api/rules/${id}`, { method: 'DELETE' });
        loadRules();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function createRuleFromTraffic() {
      if (!selectedTraffic) return;
      const t = selectedTraffic;

      // Filter out problematic headers that shouldn't be in mock responses
      const headersToRemove = [
        'content-encoding',    // Body is already decompressed
        'transfer-encoding',   // Not applicable for mock
        'content-length',      // Will be recalculated
        'connection',          // Not applicable
        'keep-alive',          // Not applicable
        'set-cookie'           // Cookies shouldn't be mocked usually
      ];

      let cleanHeaders = { 'Content-Type': 'application/json' };
      if (t.response?.headers) {
        cleanHeaders = {};
        for (const [key, value] of Object.entries(t.response.headers)) {
          if (!headersToRemove.includes(key.toLowerCase())) {
            cleanHeaders[key] = value;
          }
        }
        // Ensure Content-Type is present
        if (!cleanHeaders['Content-Type'] && !cleanHeaders['content-type']) {
          cleanHeaders['Content-Type'] = 'application/json';
        }
      }

      showRuleModal({
        description: `Mock for ${t.url}`,
        urlPattern: t.url,
        urlPatternType: 'exact',
        method: t.method,
        statusCode: t.response?.status || 200,
        headers: cleanHeaders,
        body: t.response?.body || '{}'
      });
      hideTrafficModal();
    }

    async function exportRules() {
      window.open('/api/rules/export', '_blank');
    }

    // Recordings
    async function loadRecordings() {
      try {
        const res = await fetch('/api/recordings');
        const recordings = await res.json();
        renderRecordings(recordings);
      } catch (err) {
        console.error(err);
      }
    }

    function renderRecordings(recordings) {
      const container = document.getElementById('recordingsList');
      if (recordings.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400">No recordings yet.</div>';
        return;
      }

      container.innerHTML = recordings.map(r => `
        <div class="p-4 flex items-center justify-between hover:bg-gray-50">
          <div>
            <div class="font-medium">${r.name}</div>
            <div class="text-sm text-gray-500">${r.requestCount} requests - ${new Date(r.startedAt).toLocaleString()}</div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="convertToRules('${r.id}')" class="px-3 py-1 bg-blue-100 text-blue-600 text-sm rounded hover:bg-blue-200">Convert to Rules</button>
          </div>
        </div>
      `).join('');
    }

    async function toggleRecording() {
      try {
        if (isRecording) {
          await fetch('/api/recordings/stop', { method: 'POST' });
        } else {
          const name = prompt('Recording name:', `Recording ${new Date().toLocaleString()}`);
          if (name === null) return;
          await fetch('/api/recordings/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
          });
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function updateRecordingUI() {
      const btn = document.getElementById('recordBtn');
      const status = document.getElementById('recordingStatus');

      if (isRecording) {
        btn.textContent = 'Stop Recording';
        btn.className = 'px-3 py-1.5 bg-gray-500 text-white text-sm rounded hover:bg-gray-600';
        status.innerHTML = '<span class="inline-block w-2 h-2 bg-red-500 rounded-full animate-pulse mr-1"></span> Recording...';
      } else {
        btn.textContent = 'Start Recording';
        btn.className = 'px-3 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600';
        status.textContent = '';
      }
    }

    async function convertToRules(id) {
      try {
        const res = await fetch(`/api/recordings/${id}/to-rules`, { method: 'POST' });
        const rules = await res.json();
        alert(`Created ${rules.length} mock rules from recording`);
        loadRules();
        switchTab('rules');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
  </script>
</body>
</html>
